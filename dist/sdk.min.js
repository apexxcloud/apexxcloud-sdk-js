!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).ApexxCloudSDK=t()}(this,(function(){"use strict";return class{constructor(e={}){this.config={baseUrl:e.baseUrl||"https://api.apexxcloud.com"},this.files={upload:this.uploadFile.bind(this),uploadMultipart:this.uploadMultipart.bind(this)}}async uploadMultipart(e,t,{onProgress:r=()=>{},onPartComplete:a=()=>{},onComplete:o=()=>{},onError:s=()=>{},partSize:p=5242880,signal:n,concurrency:l=3}={}){let i=new Set;const d=()=>{i.forEach((e=>e.abort())),i.clear()};n?.addEventListener("abort",(()=>{d(),s({type:"abort",error:new Error("Upload aborted"),phase:"upload",timestamp:new Date})}));try{const d=await t("start-multipart",{key:e.name,totalParts:Math.ceil(e.size/p),mimeType:e.type}),m=()=>new Promise(((t,r)=>{const a=new XMLHttpRequest;if(i.add(a),n?.aborted)return s({type:"abort",error:new Error("Upload aborted"),phase:"start",timestamp:new Date}),void r(new Error("Upload aborted"));a.open("POST",d),a.setRequestHeader("Content-Type","application/json"),a.onload=()=>{if(i.delete(a),a.status>=200&&a.status<300){JSON.parse(a.responseText);t(JSON.parse(a.responseText))}else{const e=new Error(`Start upload failed with status ${a.status}`);s({type:"error",error:e,phase:"start",status:a.status,timestamp:new Date}),r(e)}},a.onerror=()=>{i.delete(a);const e=new Error("Start upload failed");s({type:"error",error:e,phase:"start",timestamp:new Date}),r(e)},a.send(JSON.stringify({filename:e.name,contentType:e.type,size:e.size}))})),u=(await m()).data.uploadId,c=Math.ceil(e.size/p),w=[];let y=0;const f=async o=>{const l=(o-1)*p,d=Math.min(l+p,e.size),m=e.slice(l,d),w=await t("uploadpart",{uploadId:u,partNumber:o,key:e.name,totalParts:c});return new Promise(((t,p)=>{const u=new XMLHttpRequest;if(i.add(u),n?.aborted)return void p(new Error("Upload aborted"));u.upload.onprogress=t=>{if(t.lengthComputable){const a=t.loaded/t.total,s=(d-l)*a,p=(y+s)/e.size*100;r({loaded:y+s,total:e.size,progress:p,part:{number:o,progress:100*a}})}},u.open("POST",w),u.onload=()=>{if(i.delete(u),u.status>=200&&u.status<300)try{const e=JSON.parse(u.responseText).data;y+=m.size;const r={ETag:e.ETag,PartNumber:e.partNumber};a(r),t(r)}catch(e){const t=new Error("Invalid JSON response from upload part");s({type:"error",error:t,phase:"upload",partNumber:o,status:u.status,timestamp:new Date}),p(t)}else{let e;try{e=JSON.parse(u.responseText).message||`Part upload failed with status ${u.status}`}catch(t){e=u.responseText||`Part upload failed with status ${u.status}`}const t=new Error(e);s({type:"error",error:t,phase:"upload",partNumber:o,status:u.status,timestamp:new Date}),p(t)}},u.onerror=()=>{i.delete(u),p(new Error("Part upload failed"))};const c=new FormData;c.append("file",m,e.name),u.send(c)}))};for(let e=0;e<c;e+=l){const t=Array.from({length:Math.min(l,c-e)},((t,r)=>e+r+1)),r=await Promise.all(t.map((e=>f(e))));w.push(...r)}const h=await t("completemultipart",{uploadId:u,key:e.name}),b=()=>new Promise(((t,a)=>{const s=new XMLHttpRequest;i.add(s),s.open("POST",h),s.setRequestHeader("Content-Type","application/json"),s.upload.onprogress=t=>{t.lengthComputable&&r({loaded:e.size,total:e.size,progress:100,phase:"complete",type:"progress"})},s.onload=()=>{if(i.delete(s),s.status>=200&&s.status<300){const a=JSON.parse(s.responseText);r({loaded:e.size,total:e.size,progress:100,phase:"complete",type:"progress"}),o({type:"complete",response:a,timestamp:new Date,file:{name:e.name,size:e.size,type:e.type}}),t(a)}else a(new Error(`Complete upload failed with status ${s.status}`))},s.onerror=()=>{i.delete(s),a(new Error("Complete upload failed"))},s.send(JSON.stringify({parts:w.sort(((e,t)=>e.PartNumber-t.PartNumber))}))}));return await b()}catch(e){throw d(),s({type:"error",error:e,phase:"upload",timestamp:new Date}),e}}async uploadFile(e,t,{onProgress:r=()=>{},onComplete:a=()=>{},onError:o=()=>{},onStart:s=()=>{},signal:p}={}){try{const n=await t("upload",{key:e.name,mimeType:e.type}),l=new XMLHttpRequest;if(p?.aborted)throw o({type:"abort",error:new Error("Upload aborted"),timestamp:new Date}),new Error("Upload aborted");return p?.addEventListener("abort",(()=>{l.abort(),o({type:"abort",error:new Error("Upload aborted"),timestamp:new Date})})),new Promise(((t,p)=>{l.open("PUT",n),l.upload.onprogress=e=>{if(e.lengthComputable){const t=e.loaded/e.total*100;r({loaded:e.loaded,total:e.total,progress:t,type:"progress"})}},l.upload.onloadstart=()=>{s({type:"start",timestamp:new Date,file:{name:e.name,size:e.size,type:e.type}})},l.onload=()=>{if(l.status>=200&&l.status<300)try{const r=JSON.parse(l.responseText);a({type:"complete",response:r,timestamp:new Date,file:{name:e.name,size:e.size,type:e.type}}),t(r)}catch(r){a({type:"complete",response:l.responseText,timestamp:new Date,file:{name:e.name,size:e.size,type:e.type}}),t(l.responseText)}else{const e=new Error(`Upload failed with status ${l.status}`);o({type:"error",error:e,status:l.status,timestamp:new Date}),p(e)}},l.onerror=()=>{const e=new Error("Upload failed");o({type:"error",error:e,timestamp:new Date}),p(e)},l.onabort=()=>{const e=new Error("Upload aborted");o({type:"abort",error:e,timestamp:new Date}),p(e)};const i=new FormData;i.append("file",e),l.send(i)}))}catch(e){throw o({type:"error",error:e,timestamp:new Date}),e}}}}));
//# sourceMappingURL=sdk.min.js.map
